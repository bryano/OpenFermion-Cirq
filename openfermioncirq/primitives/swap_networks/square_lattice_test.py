# Copyright 2018 The Cirq Developers
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import itertools
from typing import FrozenSet, Set, Tuple

import pytest

import cirq

from cirq.contrib.acquaintance.bipartite import (
        BipartiteGraphType)
from cirq.contrib.acquaintance.gates import (
        AcquaintanceOpportunityGate)
from cirq.contrib.acquaintance.inspection_utils import (
        get_logical_acquaintance_opportunities)
from cirq.contrib.acquaintance.permutation import (
        LogicalIndex, SwapPermutationGate)
from openfermioncirq.contrib.acquaintance.strategies.square_lattice import (
        square_lattice_acquaintance_strategy)

def square_lattice_expected_acquaintance_opportunities(
        shape: Tuple[int, int],
        qubits_per_site: int=1,
        subgraph: BipartiteGraphType=BipartiteGraphType.COMPLETE
        ) -> Set[FrozenSet[LogicalIndex]]:
    width, height = shape
    opportunities = set()
    for row in range(height - 1):
        threshold = (
            0 if height == 2 else
            width // 2 if row == 0 else
            (width + (row % 2)) // 2 if row == height - 2 else
            0)
        left_sites_within_row = itertools.chain(reversed(range(threshold)),
                                                range(threshold, width))
        left_site_offsets = (qubits_per_site * (width * row + site_within_row)
                             for site_within_row in left_sites_within_row)
        step = lambda ds: -1 if ds < threshold else 1
        left_qubits_by_site = ((site_offset + qubit_offset for qubit_offset in
                                range(qubits_per_site)[::step(site_within_row)])
                               for site_within_row, site_offset
                               in enumerate(left_site_offsets))
        right_sites_within_row = range(2 * width - 1, width - 1, -1)
        right_site_offsets = (qubits_per_site * (width * row + site_within_row)
                             for site_within_row in right_sites_within_row)
        right_qubits_by_site = ((site_offset + qubit_offset for qubit_offset in
                                 reversed(range(qubits_per_site)))
                                for site_offset in right_site_offsets)
        for left_qubits, right_qubits in zip(
                left_qubits_by_site, right_qubits_by_site):
            if subgraph == BipartiteGraphType.COMPLETE:
                new_opportunities = itertools.product(left_qubits, right_qubits)
            elif subgraph == BipartiteGraphType.MATCHING:
                new_opportunities = zip(left_qubits, right_qubits)
            opportunities.update(map(frozenset, new_opportunities))
    return opportunities


no_decomp = (lambda op: isinstance(op.gate,
    (AcquaintanceOpportunityGate, SwapPermutationGate)))
expander = cirq.ExpandComposite(no_decomp=no_decomp)

# pragma pylint: disable=line-too-long
diagrams = {
    (2, 2):
"""
0: ───────0↦1───────
          │
1: ───█───1↦0───█───
      │         │
2: ───█───0↦1───█───
          │
3: ───────1↦0───────
""",
    (2, 3):
"""
0: ───────0↦1───────
          │
1: ───█───1↦0───█───
      │         │
2: ───█───0↦1───█───
          │
3: ───█───1↦0───█───
      │         │
4: ───█───0↦1───█───
          │
5: ───────1↦0───────
""",
    (2, 4):
"""
0: ───────0↦1───────
          │
1: ───█───1↦0───█───
      │         │
2: ───█───0↦1───█───
          │
3: ───█───1↦0───█───
      │         │
4: ───█───0↦1───█───
          │
5: ───█───1↦0───█───
      │         │
6: ───█───0↦1───█───
          │
7: ───────1↦0───────
""",
    (2, 5):
"""
0: ───────0↦1───────
          │
1: ───█───1↦0───█───
      │         │
2: ───█───0↦1───█───
          │
3: ───█───1↦0───█───
      │         │
4: ───█───0↦1───█───
          │
5: ───█───1↦0───█───
      │         │
6: ───█───0↦1───█───
          │
7: ───█───1↦0───█───
      │         │
8: ───█───0↦1───█───
          │
9: ───────1↦0───────
""",
    (3, 2):
"""
0: ─────────────0↦1─────────────
                │
1: ───────0↦1───1↦0───0↦1───────
          │           │
2: ───█───1↦0───█─────1↦0───█───
      │         │           │
3: ───█───0↦1───█─────0↦1───█───
          │           │
4: ───────1↦0───0↦1───1↦0───────
                │
5: ─────────────1↦0─────────────
""",
    (3, 3):
"""
0: ─────────────0↦1───────────────────
                │
1: ───────0↦1───1↦0───0↦1─────────────
          │           │
2: ───█───1↦0───█─────1↦0───█─────────
      │         │           │
3: ───█───0↦1───█─────0↦1───█─────────
          │           │
4: ───────1↦0───0↦1───1↦0───0↦1───────
                │           │
5: ───────█─────1↦0───█─────1↦0───█───
          │           │           │
6: ───────█─────0↦1───█─────0↦1───█───
                │           │
7: ─────────────1↦0───0↦1───1↦0───────
                      │
8: ───────────────────1↦0─────────────
""",
    (3, 4):
"""
0: ──────────────0↦1───────────────────
                 │
1: ────────0↦1───1↦0───0↦1─────────────
           │           │
2: ────█───1↦0───█─────1↦0───█─────────
       │         │           │
3: ────█───0↦1───█─────0↦1───█─────────
           │           │
4: ────────1↦0───0↦1───1↦0───0↦1───────
                 │           │
5: ────────█─────1↦0───█─────1↦0───█───
           │           │           │
6: ────────█─────0↦1───█─────0↦1───█───
                 │           │
7: ────────0↦1───1↦0───0↦1───1↦0───────
           │           │
8: ────█───1↦0───█─────1↦0───█─────────
       │         │           │
9: ────█───0↦1───█─────0↦1───█─────────
           │           │
10: ───────1↦0───0↦1───1↦0─────────────
                 │
11: ─────────────1↦0───────────────────
""",
    (3, 5):
"""
0: ──────────────0↦1───────────────────
                 │
1: ────────0↦1───1↦0───0↦1─────────────
           │           │
2: ────█───1↦0───█─────1↦0───█─────────
       │         │           │
3: ────█───0↦1───█─────0↦1───█─────────
           │           │
4: ────────1↦0───0↦1───1↦0───0↦1───────
                 │           │
5: ────────█─────1↦0───█─────1↦0───█───
           │           │           │
6: ────────█─────0↦1───█─────0↦1───█───
                 │           │
7: ────────0↦1───1↦0───0↦1───1↦0───────
           │           │
8: ────█───1↦0───█─────1↦0───█─────────
       │         │           │
9: ────█───0↦1───█─────0↦1───█─────────
           │           │
10: ───────1↦0───0↦1───1↦0───0↦1───────
                 │           │
11: ───────█─────1↦0───█─────1↦0───█───
           │           │           │
12: ───────█─────0↦1───█─────0↦1───█───
                 │           │
13: ─────────────1↦0───0↦1───1↦0───────
                       │
14: ───────────────────1↦0─────────────
""",
    (4, 2):
"""
0: ───────────────────0↦1───────────────────
                      │
1: ─────────────0↦1───1↦0───0↦1─────────────
                │           │
2: ───────0↦1───1↦0───0↦1───1↦0───0↦1───────
          │           │           │
3: ───█───1↦0───█─────1↦0───█─────1↦0───█───
      │         │           │           │
4: ───█───0↦1───█─────0↦1───█─────0↦1───█───
          │           │           │
5: ───────1↦0───0↦1───1↦0───0↦1───1↦0───────
                │           │
6: ─────────────1↦0───0↦1───1↦0─────────────
                      │
7: ───────────────────1↦0───────────────────
""",
    (4, 3):
"""
0: ────────────────────0↦1───────────────────
                       │
1: ──────────────0↦1───1↦0───0↦1─────────────
                 │           │
2: ────────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
3: ────█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
4: ────█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
5: ────────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
6: ────────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
7: ────█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
8: ────█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
9: ────────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
10: ─────────────1↦0───0↦1───1↦0─────────────
                       │
11: ───────────────────1↦0───────────────────
""",
    (4, 4):
"""
0: ────────────────────0↦1───────────────────
                       │
1: ──────────────0↦1───1↦0───0↦1─────────────
                 │           │
2: ────────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
3: ────█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
4: ────█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
5: ────────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
6: ────────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
7: ────█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
8: ────█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
9: ────────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
10: ───────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
11: ───█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
12: ───█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
13: ───────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
14: ─────────────1↦0───0↦1───1↦0─────────────
                       │
15: ───────────────────1↦0───────────────────
""",
    (4, 5):
"""
0: ────────────────────0↦1───────────────────
                       │
1: ──────────────0↦1───1↦0───0↦1─────────────
                 │           │
2: ────────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
3: ────█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
4: ────█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
5: ────────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
6: ────────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
7: ────█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
8: ────█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
9: ────────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
10: ───────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
11: ───█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
12: ───█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
13: ───────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
14: ───────0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │
15: ───█───1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │
16: ───█───0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │
17: ───────1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │
18: ─────────────1↦0───0↦1───1↦0─────────────
                       │
19: ───────────────────1↦0───────────────────
""",
    (5, 2):
"""
0: ─────────────────────────0↦1─────────────────────────
                            │
1: ───────────────────0↦1───1↦0───0↦1───────────────────
                      │           │
2: ─────────────0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                │           │           │
3: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
          │           │           │           │
4: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
      │         │           │           │           │
5: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
          │           │           │           │
6: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                │           │           │
7: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                      │           │
8: ───────────────────1↦0───0↦1───1↦0───────────────────
                            │
9: ─────────────────────────1↦0─────────────────────────
""",
    (5, 3):
"""
0: ──────────────────────────0↦1───────────────────────────────
                             │
1: ────────────────────0↦1───1↦0───0↦1─────────────────────────
                       │           │
2: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                 │           │           │
3: ────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
           │           │           │           │
4: ────█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────────
       │         │           │           │           │
5: ────█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────────
           │           │           │           │
6: ────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                 │           │           │
7: ──────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                       │           │           │
8: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
                 │           │           │           │
9: ────────█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
           │           │           │           │           │
10: ───────█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
                 │           │           │           │
11: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                       │           │           │
12: ───────────────────1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                             │           │
13: ─────────────────────────1↦0───0↦1───1↦0───────────────────
                                   │
14: ───────────────────────────────1↦0─────────────────────────
""",
    (5, 4):
"""
0: ──────────────────────────0↦1───────────────────────────────
                             │
1: ────────────────────0↦1───1↦0───0↦1─────────────────────────
                       │           │
2: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                 │           │           │
3: ────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
           │           │           │           │
4: ────█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────────
       │         │           │           │           │
5: ────█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────────
           │           │           │           │
6: ────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                 │           │           │
7: ──────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                       │           │           │
8: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
                 │           │           │           │
9: ────────█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
           │           │           │           │           │
10: ───────█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
                 │           │           │           │
11: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                       │           │           │
12: ─────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                 │           │           │
13: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
           │           │           │           │
14: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────────
       │         │           │           │           │
15: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────────
           │           │           │           │
16: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                 │           │           │
17: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───────────────────
                       │           │
18: ───────────────────1↦0───0↦1───1↦0─────────────────────────
                             │
19: ─────────────────────────1↦0───────────────────────────────
""",
    (5, 5):
"""
0: ──────────────────────────0↦1───────────────────────────────
                             │
1: ────────────────────0↦1───1↦0───0↦1─────────────────────────
                       │           │
2: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                 │           │           │
3: ────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
           │           │           │           │
4: ────█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────────
       │         │           │           │           │
5: ────█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────────
           │           │           │           │
6: ────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                 │           │           │
7: ──────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                       │           │           │
8: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
                 │           │           │           │
9: ────────█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
           │           │           │           │           │
10: ───────█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
                 │           │           │           │
11: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                       │           │           │
12: ─────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                 │           │           │
13: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
           │           │           │           │
14: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────────
       │         │           │           │           │
15: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────────
           │           │           │           │
16: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                 │           │           │
17: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                       │           │           │
18: ─────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
                 │           │           │           │
19: ───────█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
           │           │           │           │           │
20: ───────█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
                 │           │           │           │
21: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                       │           │           │
22: ───────────────────1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                             │           │
23: ─────────────────────────1↦0───0↦1───1↦0───────────────────
                                   │
24: ───────────────────────────────1↦0─────────────────────────
""",
    (6, 2):
"""
0: ────────────────────────────────0↦1───────────────────────────────
                                   │
1: ──────────────────────────0↦1───1↦0───0↦1─────────────────────────
                             │           │
2: ────────────────────0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                       │           │           │
3: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
4: ────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
5: ────█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
6: ────█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
7: ────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
8: ──────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
9: ────────────────────1↦0───0↦1───1↦0───0↦1───1↦0───────────────────
                             │           │
10: ─────────────────────────1↦0───0↦1───1↦0─────────────────────────
                                   │
11: ───────────────────────────────1↦0───────────────────────────────
""",
    (6, 3):
"""
0: ────────────────────────────────0↦1───────────────────────────────
                                   │
1: ──────────────────────────0↦1───1↦0───0↦1─────────────────────────
                             │           │
2: ────────────────────0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                       │           │           │
3: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
4: ────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
5: ────█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
6: ────█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
7: ────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
8: ──────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
9: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
10: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
11: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
12: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
13: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
14: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
15: ───────────────────1↦0───0↦1───1↦0───0↦1───1↦0───────────────────
                             │           │
16: ─────────────────────────1↦0───0↦1───1↦0─────────────────────────
                                   │
17: ───────────────────────────────1↦0───────────────────────────────
""",
    (6, 4):
"""
0: ────────────────────────────────0↦1───────────────────────────────
                                   │
1: ──────────────────────────0↦1───1↦0───0↦1─────────────────────────
                             │           │
2: ────────────────────0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                       │           │           │
3: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
4: ────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
5: ────█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
6: ────█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
7: ────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
8: ──────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
9: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
10: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
11: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
12: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
13: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
14: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
15: ─────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
16: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
17: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
18: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
19: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
20: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
21: ───────────────────1↦0───0↦1───1↦0───0↦1───1↦0───────────────────
                             │           │
22: ─────────────────────────1↦0───0↦1───1↦0─────────────────────────
                                   │
23: ───────────────────────────────1↦0───────────────────────────────
""",
    (6, 5):
"""
0: ────────────────────────────────0↦1───────────────────────────────
                                   │
1: ──────────────────────────0↦1───1↦0───0↦1─────────────────────────
                             │           │
2: ────────────────────0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                       │           │           │
3: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
4: ────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
5: ────█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
6: ────█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
7: ────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
8: ──────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
9: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
10: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
11: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
12: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
13: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
14: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
15: ─────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
16: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
17: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
18: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
19: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
20: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
21: ─────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                 │           │           │           │
22: ───────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
           │           │           │           │           │
23: ───█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
       │         │           │           │           │           │
24: ───█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
           │           │           │           │           │
25: ───────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                 │           │           │           │
26: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                       │           │           │
27: ───────────────────1↦0───0↦1───1↦0───0↦1───1↦0───────────────────
                             │           │
28: ─────────────────────────1↦0───0↦1───1↦0─────────────────────────
                                   │
29: ───────────────────────────────1↦0───────────────────────────────
""",
    (7, 3):
"""
0: ──────────────────────────────────────0↦1───────────────────────────────────────────
                                         │
1: ────────────────────────────────0↦1───1↦0───0↦1─────────────────────────────────────
                                   │           │
2: ──────────────────────────0↦1───1↦0───0↦1───1↦0───0↦1───────────────────────────────
                             │           │           │
3: ────────────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────────────────
                       │           │           │           │
4: ──────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                 │           │           │           │           │
5: ────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
           │           │           │           │           │           │
6: ────█───1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────────
       │         │           │           │           │           │           │
7: ────█───0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────────
           │           │           │           │           │           │
8: ────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                 │           │           │           │           │
9: ──────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────────────────
                       │           │           │           │
10: ───────────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────────────────
                             │           │           │           │
11: ───────────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1─────────────
                       │           │           │           │           │
12: ─────────────0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───────
                 │           │           │           │           │           │
13: ───────█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█─────1↦0───█───
           │           │           │           │           │           │           │
14: ───────█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█─────0↦1───█───
                 │           │           │           │           │           │
15: ─────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────
                       │           │           │           │           │
16: ───────────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0─────────────
                             │           │           │           │
17: ─────────────────────────1↦0───0↦1───1↦0───0↦1───1↦0───0↦1───1↦0───────────────────
                                   │           │           │
18: ───────────────────────────────1↦0───0↦1───1↦0───0↦1───1↦0─────────────────────────
                                         │           │
19: ─────────────────────────────────────1↦0───0↦1───1↦0───────────────────────────────
                                               │
20: ───────────────────────────────────────────1↦0─────────────────────────────────────
"""
}
# pragma pylint: enable=line-too-long


@pytest.mark.parametrize('shape', diagrams)
def test_square_lattice_diagrams(shape):
    (width, height) = shape
    n_qubits = width * height
    qubits = cirq.LineQubit.range(n_qubits)
    strategy = square_lattice_acquaintance_strategy(shape, qubit_order=qubits)
    expander(strategy)
    cirq.DropEmptyMoments()(strategy)
    expected_diagram = diagrams[shape]
    cirq.testing.assert_has_diagram(strategy, expected_diagram)


@pytest.mark.parametrize('shape,qubits_per_site,subgraph',
    itertools.product(
        itertools.product(range(1, 10), range(1, 6)),
        range(1, 5), BipartiteGraphType)
)
def test_square_lattice_acquaintance_opportunities(
        shape, qubits_per_site, subgraph):
    width, height = shape
    n_qubits = width * height * qubits_per_site
    qubits = cirq.LineQubit.range(n_qubits)
    strategy = square_lattice_acquaintance_strategy(shape, qubit_order=qubits,
            qubits_per_site=qubits_per_site, subgraph=subgraph)
    initial_mapping = {q: i for i, q in enumerate(qubits)}
    opportunities = get_logical_acquaintance_opportunities(
            strategy, initial_mapping)
    expected_opportunities = (
            square_lattice_expected_acquaintance_opportunities(
                shape, qubits_per_site, subgraph))
    assert opportunities == expected_opportunities
